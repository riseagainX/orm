# üí≥ What is a Coupon Code? Complete Guide with Examples

## üéØ What is a Coupon?

A **coupon code** is a special discount code that customers can enter during checkout to get a price reduction on their order.

Think of it like a **gift card** or **discount voucher** you might use at a restaurant or store!

---

## üè™ Real-World Examples

### Example 1: Restaurant Coupon
```
You go to a restaurant and your bill is:
- Pizza: ‚Çπ500
- Pasta: ‚Çπ300
- Drink: ‚Çπ200
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Total: ‚Çπ1,000

You have a coupon: "FIRST100" for ‚Çπ100 off

Final bill: ‚Çπ1,000 - ‚Çπ100 = ‚Çπ900
You saved: ‚Çπ100 ‚úÖ
```

### Example 2: Shopping Website
```
Amazon Gift Cards:
- ‚Çπ500 card √ó 2 = ‚Çπ1,000
- ‚Çπ250 card √ó 1 = ‚Çπ250
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Subtotal: ‚Çπ1,250

Coupon: "WELCOME500" for ‚Çπ500 off
Final: ‚Çπ1,250 - ‚Çπ500 = ‚Çπ750
You saved: ‚Çπ500 ‚úÖ
```

---

## üíª How Coupons Work in DBS Bank System

### The Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    COUPON REDEMPTION FLOW                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1Ô∏è‚É£ USER ADDS ITEMS TO CART
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ Cart         ‚îÇ
   ‚îÇ ‚Ä¢ Amazon GV  ‚îÇ ‚Çπ500
   ‚îÇ ‚Ä¢ Flipkart   ‚îÇ ‚Çπ300
   ‚îÇ ‚Ä¢ Myntra     ‚îÇ ‚Çπ200
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   Subtotal: ‚Çπ1,000

2Ô∏è‚É£ USER ENTERS COUPON CODE
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ Coupon: WELCOME600   ‚îÇ ‚Üê User types this
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

3Ô∏è‚É£ SYSTEM VALIDATES COUPON
   ‚úÖ Code exists in database
   ‚úÖ Not expired (valid till date)
   ‚úÖ Not already used
   ‚úÖ Active status
   ‚úÖ Minimum order value met (‚Çπ1,000 ‚â• ‚Çπ500)
   ‚úÖ Not in other carts/orders
   
4Ô∏è‚É£ SYSTEM APPLIES DISCOUNT SEQUENTIALLY
   Amazon:   ‚Çπ500 - ‚Çπ500 = ‚Çπ0   (full discount)
   Flipkart: ‚Çπ300 - ‚Çπ100 = ‚Çπ200 (partial discount)
   Myntra:   ‚Çπ200 - ‚Çπ0   = ‚Çπ200 (no discount left)
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   Final: ‚Çπ400 (saved ‚Çπ600!)

5Ô∏è‚É£ USER PAYS REDUCED AMOUNT
   üí≥ Payment: ‚Çπ400 instead of ‚Çπ1,000
   üéâ Savings: ‚Çπ600
```

---

## üìã Coupon Database Structure

Coupons are stored in the `coupon_code` table:

```sql
CREATE TABLE coupon_code (
  id                BIGINT PRIMARY KEY,
  user_id           BIGINT,              -- Which user owns this coupon?
  coupon_code       VARCHAR(150),        -- The code: "WELCOME100"
  valid_from        DATE,                -- Start date
  valid_till        DATE,                -- End date
  min_order_value   INT,                 -- Minimum cart total required
  amount            INT,                 -- Discount amount in rupees
  is_used           TINYINT DEFAULT 0,   -- 0 = unused, 1 = used
  status            ENUM('A', 'I'),      -- A = Active, I = Inactive
  created           TIMESTAMP
);
```

### Example Coupon Record
```json
{
  "id": 1,
  "user_id": 123,
  "coupon_code": "WELCOME500",
  "valid_from": "2025-01-01",
  "valid_till": "2025-12-31",
  "min_order_value": 500,
  "amount": 500,
  "is_used": 0,
  "status": "A"
}
```

**Translation:**
- User #123 has a coupon "WELCOME500"
- Valid for entire year 2025
- Requires minimum ‚Çπ500 order
- Gives ‚Çπ500 discount
- Not yet used
- Currently active

---

## üîê Coupon Validation (7 Checks)

Before applying a coupon, we check:

### 1Ô∏è‚É£ Does the coupon exist?
```sql
SELECT * FROM coupon_code WHERE coupon_code = 'WELCOME500'
```
‚ùå If not found ‚Üí "Coupon not found"

### 2Ô∏è‚É£ Is it already used?
```sql
WHERE is_used = 0
```
‚ùå If used ‚Üí "Coupon already used"

### 3Ô∏è‚É£ Is it active?
```sql
WHERE status = 'A'
```
‚ùå If inactive ‚Üí "Coupon is inactive"

### 4Ô∏è‚É£ Is it expired?
```sql
WHERE valid_till >= CURRENT_DATE
```
‚ùå If expired ‚Üí "Coupon has expired"

### 5Ô∏è‚É£ Is it already in user's cart?
```sql
SELECT * FROM cart_items WHERE user_id = 123 AND coupon_id = 1
```
‚ùå If found ‚Üí "Coupon already in your cart"

### 6Ô∏è‚É£ Is it already used in previous orders?
```sql
SELECT * FROM orders WHERE user_id = 123 AND coupon_id = 1
```
‚ùå If found ‚Üí "Coupon already used in previous order"

### 7Ô∏è‚É£ Does order meet minimum value?
```javascript
if (orderTotal < coupon.min_order_value) {
  throw "Minimum order value of ‚Çπ500 not met";
}
```
‚ùå If less ‚Üí "Minimum order value not met"

‚úÖ **All checks pass ‚Üí Coupon is valid!**

---

## üí∞ Real Examples with Numbers

### Example 1: Simple Coupon

**Setup:**
```
Cart:
- Amazon Gift Card ‚Çπ1,000 √ó 1 = ‚Çπ1,000

Coupon: SAVE200
- Amount: ‚Çπ200 off
- Min order: ‚Çπ500
```

**Calculation:**
```
Original price:    ‚Çπ1,000
Coupon discount:   -‚Çπ200
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Final amount:      ‚Çπ800

‚úÖ User pays: ‚Çπ800
üíæ Saves: ‚Çπ200
```

---

### Example 2: Coupon Exceeds Single Item

**Setup:**
```
Cart:
- Flipkart GV ‚Çπ500 √ó 1 = ‚Çπ500
- Myntra GV ‚Çπ300 √ó 1 = ‚Çπ300

Coupon: MEGA600
- Amount: ‚Çπ600 off
- Min order: ‚Çπ500
```

**Sequential Distribution:**
```
Step 1: Apply to Flipkart (‚Çπ500)
  Coupon available: ‚Çπ600
  Item price: ‚Çπ500
  Discount: min(‚Çπ600, ‚Çπ500) = ‚Çπ500
  Item final: ‚Çπ500 - ‚Çπ500 = ‚Çπ0 ‚úÖ
  Remaining coupon: ‚Çπ600 - ‚Çπ500 = ‚Çπ100

Step 2: Apply to Myntra (‚Çπ300)
  Coupon available: ‚Çπ100
  Item price: ‚Çπ300
  Discount: min(‚Çπ100, ‚Çπ300) = ‚Çπ100
  Item final: ‚Çπ300 - ‚Çπ100 = ‚Çπ200 ‚úÖ
  Remaining coupon: ‚Çπ100 - ‚Çπ100 = ‚Çπ0

Final breakdown:
  Flipkart: ‚Çπ0 (was ‚Çπ500)
  Myntra:   ‚Çπ200 (was ‚Çπ300)
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  Total:    ‚Çπ200 (was ‚Çπ800)
  
‚úÖ User pays: ‚Çπ200
üíæ Saves: ‚Çπ600
```

---

### Example 3: Coupon + Promotion

**Setup:**
```
Cart:
- Amazon GV ‚Çπ1,000 √ó 1 = ‚Çπ1,000

Coupon: SAVE300
- Amount: ‚Çπ300 off

Promotion: 10% off
```

**Order of Discounts:**
```
Step 1: Apply coupon FIRST
  Original: ‚Çπ1,000
  Coupon:   -‚Çπ300
  After:    ‚Çπ700

Step 2: Apply promotion on discounted amount
  After coupon: ‚Çπ700
  Promotion: 10% of ‚Çπ700 = ‚Çπ70
  Final: ‚Çπ700 - ‚Çπ70 = ‚Çπ630

Final breakdown:
  Original price:       ‚Çπ1,000
  Coupon discount:      -‚Çπ300
  Promotion discount:   -‚Çπ70
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  Final amount:         ‚Çπ630
  
‚úÖ User pays: ‚Çπ630
üíæ Total savings: ‚Çπ370
```

**Important:** Coupon is ALWAYS applied before promotion!

---

### Example 4: Multiple Items

**Setup:**
```
Cart:
- Product A: ‚Çπ500
- Product B: ‚Çπ400
- Product C: ‚Çπ300
- Product D: ‚Çπ200
Total: ‚Çπ1,400

Coupon: SUPER1000
- Amount: ‚Çπ1,000 off
- Min order: ‚Çπ1,000
```

**Distribution:**
```
Remaining coupon starts at: ‚Çπ1,000

Product A (‚Çπ500):
  Apply: min(‚Çπ1,000, ‚Çπ500) = ‚Çπ500
  Pays: ‚Çπ500 - ‚Çπ500 = ‚Çπ0
  Remaining: ‚Çπ1,000 - ‚Çπ500 = ‚Çπ500

Product B (‚Çπ400):
  Apply: min(‚Çπ500, ‚Çπ400) = ‚Çπ400
  Pays: ‚Çπ400 - ‚Çπ400 = ‚Çπ0
  Remaining: ‚Çπ500 - ‚Çπ400 = ‚Çπ100

Product C (‚Çπ300):
  Apply: min(‚Çπ100, ‚Çπ300) = ‚Çπ100
  Pays: ‚Çπ300 - ‚Çπ100 = ‚Çπ200
  Remaining: ‚Çπ100 - ‚Çπ100 = ‚Çπ0

Product D (‚Çπ200):
  Apply: min(‚Çπ0, ‚Çπ200) = ‚Çπ0
  Pays: ‚Çπ200 - ‚Çπ0 = ‚Çπ200
  Remaining: ‚Çπ0

Summary:
  Product A: ‚Çπ0 (was ‚Çπ500) - FREE! üéâ
  Product B: ‚Çπ0 (was ‚Çπ400) - FREE! üéâ
  Product C: ‚Çπ200 (was ‚Çπ300) - ‚Çπ100 off
  Product D: ‚Çπ200 (was ‚Çπ200) - No discount
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  Total: ‚Çπ400 (was ‚Çπ1,400)
  
‚úÖ User pays: ‚Çπ400
üíæ Saves: ‚Çπ1,000
üéÅ Gets 2 items FREE!
```

---

## üîÑ API Request/Response Examples

### Request: Create Order WITHOUT Coupon
```json
POST /api/orders/create
Authorization: Bearer <jwt_token>

{
  "cart_item_ids": "1,2,3",
  "display_type": "WEBSITE",
  "whatsapp": "Y"
}
```

### Response:
```json
{
  "status": true,
  "message": "Order created successfully",
  "data": {
    "order_id": 456,
    "order_guid": "DBS-123456-1698765432",
    "total_amount": 1000,
    "cash_spent": 1000,
    "coupon_applied": false,
    "coupon_code": null,
    "coupon_discount": 0,
    "payu_amount": 1000,
    "productinfo": "Amazon Gift Card,Flipkart Voucher",
    "voucher_quantity": 2
  }
}
```

---

### Request: Create Order WITH Coupon
```json
POST /api/orders/create
Authorization: Bearer <jwt_token>

{
  "cart_item_ids": "1,2,3",
  "display_type": "WEBSITE",
  "whatsapp": "Y",
  "coupon_code": "WELCOME500"  ‚Üê Added coupon!
}
```

### Response:
```json
{
  "status": true,
  "message": "Order created successfully",
  "data": {
    "order_id": 457,
    "order_guid": "DBS-123457-1698765433",
    "total_amount": 1000,
    "cash_spent": 500,             ‚Üê Reduced!
    "coupon_applied": true,        ‚Üê Coupon used!
    "coupon_code": "WELCOME500",   ‚Üê Which coupon
    "coupon_discount": 500,        ‚Üê How much saved
    "payu_amount": 500,            ‚Üê Amount to pay
    "productinfo": "Amazon Gift Card,Flipkart Voucher",
    "voucher_quantity": 2
  }
}
```

**Difference:** User pays ‚Çπ500 instead of ‚Çπ1,000! üéâ

---

### Error Response: Invalid Coupon
```json
POST /api/orders/create

{
  "cart_item_ids": "1,2,3",
  "coupon_code": "EXPIRED123"
}
```

### Response:
```json
{
  "status": false,
  "message": "Coupon has expired"
}
```

---

## üéì Key Concepts Explained

### 1. Why Sequential Distribution?

**Sequential** means "one after another, in order"

```
Think of it like eating pizza slices:

You have 6 slices of pizza.
3 friends arrive:

Friend 1: Takes 3 slices (now 3 left)
Friend 2: Takes 2 slices (now 1 left)
Friend 3: Takes 1 slice (now 0 left)

You can't give Friend 3 two slices because they're already eaten!
Same with coupons - once applied to Item 1, can't use same amount for Item 2!
```

### 2. Why Apply Coupon Before Promotion?

```
CORRECT ORDER (Coupon first):
‚Çπ1,000 ‚Üí Apply ‚Çπ500 coupon ‚Üí ‚Çπ500 ‚Üí Apply 10% promo ‚Üí ‚Çπ450

WRONG ORDER (Promotion first):
‚Çπ1,000 ‚Üí Apply 10% promo ‚Üí ‚Çπ900 ‚Üí Apply ‚Çπ500 coupon ‚Üí ‚Çπ400

User gets BETTER deal with coupon first! ‚úÖ
```

### 3. Why Validate Before Processing?

```
Imagine:
- Processing 10 items (takes time)
- Calculating all amounts
- Then discover coupon is expired üò±

Better:
- Check coupon FIRST (2 seconds)
- If invalid, stop immediately
- Saves processing time and gives instant feedback ‚úÖ
```

---

## üí° Business Rules

### 1. One Coupon Per Order
- User can only apply ONE coupon code per order
- Can't combine multiple coupons
- Must choose the best one!

### 2. Coupon Cannot Exceed Cart Total
```
Cart: ‚Çπ500
Coupon: ‚Çπ1,000

Result: User pays ‚Çπ0 (not negative!)
Maximum discount = Cart total
```

### 3. Single-Use Coupons
- Most coupons are single-use
- After order completes, marked as `is_used = 1`
- Can't reuse same coupon

### 4. Minimum Order Requirements
```
Coupon: ‚Çπ500 off on orders above ‚Çπ1,000

Cart: ‚Çπ800 ‚Üí ‚ùå Can't use (below minimum)
Cart: ‚Çπ1,200 ‚Üí ‚úÖ Can use!
```

---

## üîç Where Coupons Are Stored

### In Database Tables:

1. **`coupon_code`** - Master coupon data
   ```sql
   coupon_id: 1
   code: "WELCOME500"
   amount: 500
   ```

2. **`orders`** - Which order used which coupon
   ```sql
   order_id: 123
   coupon_id: 1  ‚Üê Links to coupon
   ```

3. **`transactions`** - Coupon as transaction
   ```sql
   txn_type: 'CR' (Credit/Discount)
   source: 'COUPON'
   amount: 500
   ```

---

## üéØ Summary

### What is a Coupon?
A discount code that reduces the order total

### Types of Coupons in DBS Bank:
- **Fixed Amount:** ‚Çπ100 off, ‚Çπ500 off
- **Minimum Order:** Must spend ‚Çπ1,000 to get ‚Çπ200 off
- **User-Specific:** Assigned to specific users
- **Time-Limited:** Valid only during certain dates

### How It Works:
1. User enters code
2. System validates (7 checks)
3. Discount applied sequentially to items
4. Promotions applied on discounted amount
5. User pays reduced total
6. Coupon marked as used

### Benefits:
- üí∞ Save money on orders
- üéÅ Sometimes items become FREE
- üéâ Encourages purchases
- üë• Rewards loyal customers

---

**Real-Life Analogy:**
```
Coupon code = Restaurant discount card
Cart items = Your ordered food
Validation = Waiter checks if card is valid
Distribution = Apply discount to bill items
Final amount = Reduced bill you pay
```

Simple! üéâ

---

**Last Updated:** October 27, 2025
**File:** `controllers/orderController.js`
**Service:** `services/createOrder.service.js`
**Helper:** `services/couponHelpers.service.js`
